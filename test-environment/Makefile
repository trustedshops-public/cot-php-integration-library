# Test Environment Makefile

.PHONY: help dev start stop clean logs status build test local local-stop

# Default target
help:
	@echo "ðŸ§ª COT Test Environment - Development Commands"
	@echo ""
	@echo "ðŸš€ Quick Start:"
	@echo "  make start        - Start local PHP server"
	@echo "  make stop         - Stop local PHP server"
	@echo "  make restart      - Restart local server"
	@echo ""
	@echo "ðŸ³ Docker Commands:"
	@echo "  make dev          - Start Docker with live file watching"
	@echo "  make docker       - Start Docker environment (simple)"
	@echo "  make docker-stop  - Stop Docker environment"
	@echo "  make docker-logs  - View Docker logs"
	@echo ""
	@echo "ðŸ”§ Development:"
	@echo "  make logs         - View container logs"
	@echo "  make status       - Show container status"
	@echo "  make build        - Build Docker image"
	@echo "  make test         - Test environment"
	@echo "  make clean        - Clean up everything"
	@echo ""

# Local Development Commands
start:
	@./start.sh

stop:
	@echo "ðŸ›‘ Stopping local PHP server..."
	@pkill -f "php -S localhost:8081" 2>/dev/null || true
	@kill -9 $$(lsof -ti:8081) 2>/dev/null || true
	@echo "âœ… Local server stopped"

# Docker Commands
dev:
	@./docker-dev.sh

docker:
	@./docker-start.sh

docker-stop:
	@./docker-stop.sh

restart: stop start

clean:
	@echo "ðŸ§¹ Cleaning up..."
	@docker-compose down -v --remove-orphans
	@docker system prune -f

logs:
	@docker-compose logs -f

status:
	@docker-compose ps

build:
	@docker-compose build

test:
	@echo "ðŸ§ª Testing environment..."
	@curl -s http://localhost:8081/oauth-integration-test.php > /dev/null && echo "âœ… Test page accessible" || echo "âŒ Test page not accessible"

# Local Development
local:
	@echo "ðŸŒ Starting local PHP server..."
	@php -S localhost:8081 -t . &
	@echo "âœ… Local server started at http://localhost:8081"
	@echo "ðŸ”— Test page: http://localhost:8081/oauth-integration-test.php"
	@echo "ðŸ›‘ To stop: make local-stop"

local-stop:
	@echo "ðŸ›‘ Stopping local PHP server..."
	@pkill -f "php -S localhost:8081" 2>/dev/null || true
	@kill -9 $$(lsof -ti:8081) 2>/dev/null || true
	@echo "âœ… Local server stopped"

# Docker Commands (Agnostic)
docker-logs:
	@docker-compose logs -f

# Quick commands
quick: clean dev
	@echo "ðŸŽ¯ Quick development environment ready!"

# Open browser
open:
	@echo "ðŸŒ Opening test page..."
	@open http://localhost:8081/oauth-integration-test.php 2>/dev/null || \
		xdg-open http://localhost:8081/oauth-integration-test.php 2>/dev/null || \
		echo "ðŸ“– Please open http://localhost:8081/oauth-integration-test.php manually"
